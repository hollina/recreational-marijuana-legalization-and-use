////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
// AUTHORS:
// Hollingsworth, Wing, and Bradford 
// hollinal@indiana.edu, cwing@indiana.edu, asbrad@iu.edu 

// TITLE:
// Comparative Effects of Recreational and Medical Marijuana Laws 
// On Drug Use Among Adults and Adolescents


// JOURNAL: 
// Journal of law and economics

// VERSION: May 2022

// FILE:
// 00.run-file.do

// DESCRIPTION:
// This file replicates our 2022 paper from raw data to the exact table
// and figures used in our paper. All data are publically available.

// GITHUB LINK:
// https://github.com/hollina/recreational-marijuana-legalization-and-use

////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////
// Set up

// Set version of stata. We can change this the lowest version we all have.
*version 15.1

// Turn on pause to make sure things are working
pause on

//////////////////////////////////////////////////////////////////////////////
// Set your file path here
global r_path "/usr/local/bin/R" // This can be found by running "which R" in terminal

///////////////////////////////////////////////////////////////////////////////
// Clear memory
clear all

///////////////////////////////////////////////////////////////////////////////
// Use included packages
cap adopath - PERSONAL
cap adopath - PLUS
cap adopath - SITE
cap adopath - OLDPLACE
adopath + "stata_packages"
net set ado "stata_packages"


// Install Stata Packages
local install_stata_packages 0 // Set to 1 to install packages

// Install Packages if needed, if not, make a note of this
if `install_stata_packages' {

	ssc install blindschemes, replace
	ssc install gtools, replace

	ssc install carryforward, replace
	ssc install estout, replace
	net install ftools, from("https://raw.githubusercontent.com/sergiocorreia/ftools/master/src/")
	net install reghdfe, from("https://raw.githubusercontent.com/sergiocorreia/reghdfe/master/src/")
	ssc install moremata
	ftools, compile
	reghdfe, compile
	ssc install ppmlhdfe
	ssc install appendfile, replace
	ssc install blindschemes, replace
	ssc install missings, replace
	ssc install carryforward, replace
	ssc install texsave, replace
	ssc install unique, replace
	ssc install distinct, replace
	net install ppmlhdfe, from("https://raw.githubusercontent.com/sergiocorreia/ppmlhdfe/master/src/") replace
}
else  {
	di "All packages up-to-date"
}

// Specify Screen Width for log files
set linesize 255

// Set font type
graph set window fontface "Times New Roman"

// Set Graph Scheme
set scheme plotplainblind

///////////////////////////////////////////////////////////////////////////////
// Set options 

// Build dataset used in analysis (0 for no; 1 for yes)
global build_data 1

// Run very slow parts of the analysis code (0 for no; 1 for yes)
// Adds ~4 hours to otherwise ~15 minute runtime. 
global slow_code 0


///////////////////////////////////////////////////////////////////////////////
// Create all of the data needed for the analysis
// ~10 min on MacBook Pro (15-inch, 2019) with 2.3 GHz 8-Core Intel Core i9 and 32 GB RAM

if $build_data == 1 {
	// ~5 min 
	do "code/01-build/01-create-control-data.do" 
	
	// <1 min 
	do "code/01-build/02-clean-nsduh-data.do" 
	
	// ~4 min
	do "code/01-build/03-clean-arrest-data.do" 
	
	// ~2 min
	do "code/01-build/04-clean-quest-data.do"
	
}


///////////////////////////////////////////////////////////////////////////////
// Analysis 
// ~6 min run time without randomization inference
// ~4 hours run time with randomization inference

// Main text
	///////////////////////////////////////////////////////////////////////////
	// Table 1: Summary statistics for NSDUH use
	// <1 min
	do "code/02-analysis/01-nsduh-table-1-summary-statistics.do"
	///////////////////////////////////////////////////////////////////////////

	///////////////////////////////////////////////////////////////////////////
	// Figures 1 and OA6: Simple twoway comparison of use pre/post by treated/not
	// <1 min
	do "code/02-analysis/02-nsduh-figure-1-and-OA6-data.do"

	// <1 min
	// Call R script (requires packages pacman, tidyverse, data.table, and cowplot)
	shell $r_path --vanilla <code/02-analysis/02.1-nsduh-figure-1-and-OA6-create.R	
	///////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////
	// Figures 2-4: BW event studies
	// ~1 min
	do "code/02-analysis/03-nsduh-event-study-figures-2-3-4-bw.do"
	do "code/02-analysis/03.1-nsduh-event-study-program.do"
	///////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////
	// Figures 5: BW main effect (also in color)
	// ~1 min
	do "code/02-analysis/04-nsduh-figure-5-bw-main-effect.do"
	do "code/02-analysis/04.1-nsduh-main-effect-color.do"
	///////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Table 2: Main table
	// <1 min
	do "code/02-analysis/05-nsduh-table-2-OA1-main-effects.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Table 3 and Figure OA4:  Quest analysis 
	// <1 min
	do "code/02-analysis/06-quest-table-3-figure-OA4.do"
	///////////////////////////////////////////////////////////////////////////////

	///////////////////////////////////////////////////////////////////////////////
	// Table 4: Arrest analysis 
	// <1 min
	do "code/02-analysis/07-arrest-table-4.do"
	///////////////////////////////////////////////////////////////////////////////

// Appendix		
	
	///////////////////////////////////////////////////////////////////////////////
	// Figure A1 and OA1: Goodman-bacon weights 
	// ~2 min
	do "code/02-analysis/08-nsduh-figure-A1-and-OA1-bacon-weights.do"
	///////////////////////////////////////////////////////////////////////////////

	
// Online Appendix 
	
	///////////////////////////////////////////////////////////////////////////////
	// Figure OA2: RM effect for non-mj substances
	// <1 min
	do "code/02-analysis/09-nsduh-figure-OA2-rm-effect-non-mj.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Figures OA3 and OA10: Additional event studies
	// ~3 min
	do "code/02-analysis/10-nsduh-event-study-figures-OA3-OA10.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Figure OA5: Comparing NSDUH to YRBSS
	// <1 min
	do "code/02-analysis/11-nsduh-figure-OA5-compare-nsduh-to-YRBSS.do"
	///////////////////////////////////////////////////////////////////////////////

	///////////////////////////////////////////////////////////////////////////////
	// Figure A1 and OA1: Goodman-bacon weights 
	// ~3 min
	do "code/02-analysis/08-nsduh-figure-A1-and-OA1-bacon-weights.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Table OA2: Randomization inference
	// ~4 hours
	// Note this code is slow. So a cached version of the table is kept in 
		// output/tables/cached
	if $slow_code == 1 {
		do "code/02-analysis/12-nsduh-1.randomization_inference.do"
		do "code/02-analysis/13-nsduh-2.store_actual_results.do"
		do "code/02-analysis/14-nsduh-3.randomization_inference_p_values.do"
		do "code/02-analysis/15-nsduh-4.set_up_new_ri.do" 
		do "code/02-analysis/16-nsduh-5.new_ri_analysis.do"
		do "code/02-analysis/17-nsduh-6.new_ri_p_value-table-OA2.do"
		do "code/02-analysis/17.1-nsduh-texsave-fragment.do"
	}
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Table OA3: drop overlapping panel years 
	// <1 min
	do "code/02-analysis/18-nsduh-table-OA3-drop-odd-years.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Tables OA4 and OA5: Aggressive treatment definition
	// <1 min
	do "code/02-analysis/19-nsduh-tables-OA4-OA5-aggressive-treatment.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Tables OA6 and OA7: Use population weights
	// <1 min
	do "code/02-analysis/20-nsduh-tables-OA6-OA7-population-weights.do"
	///////////////////////////////////////////////////////////////////////////////

	///////////////////////////////////////////////////////////////////////////////
	// Tables OA8 and OA9: Use mean instead of ln(mean) as dependent variable
	// <1 min
	do "code/02-analysis/21-nsduh-tables-OA8-OA9-untransformed-mean.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Table OA10: Covariate balance
	// <1 min
	do "code/02-analysis/22-nsduh-table-OA10-covariate-balance.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Table OA11: Change in population 
	// <1 min
	do "code/02-analysis/23-nsduh-table-OA11-change-in-population.do"
	///////////////////////////////////////////////////////////////////////////////

	///////////////////////////////////////////////////////////////////////////////
	// Tables OA12 and OA13: Use states with best pre-period match
	
	// <1 min
	do "code/02-analysis/24-nsduh-tables-OA12-OA13-best-preperiod-match.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Tables OA14 and OA15: List states with best pre-period match
	
	// <1 min
	do "code/02-analysis/25-nsduh-tables-OA14-OA15-state-list-best-preperiod-match.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Tables OA16 and OA17: Omit region-by-year fe
	
	// <1 min
	do "code/02-analysis/26-nsduh-tables-OA16-OA17-without-region-by-year-fe.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Tables OA18 and OA19: Omit region-by-year fe and controls
	
	// <1 min
	do "code/02-analysis/27-nsduh-tables-OA18-OA19-without-region-by-year-fe-or-controls.do"
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Tables OA20 and OA21: Use division-by-year fe instead of region-by-year fe
	
	// <1 min
	do "code/02-analysis/28-nsduh-tables-OA20-OA21-with-division-by-year-fe.do"
	///////////////////////////////////////////////////////////////////////////////

	///////////////////////////////////////////////////////////////////////////////
	// Figure OA7: Change in marijuana use across time
	
	// <1 min
	// Call R script (requires packages pacman, tidyverse, data.table, and cowplot)
	shell $r_path --vanilla <code/02-analysis/29-nsduh-figure-OA7.R
	!rm temp/data-for-cleveland-plot-additional.csv
	!rm temp/data-for-cleveland-plot-placebo.csv
	!rm temp/data-for-cleveland-plot.csv
	///////////////////////////////////////////////////////////////////////////////
		
	///////////////////////////////////////////////////////////////////////////////
	// Figure OA8: Change in marijuana use across time
	
	// <1 min
	do "code/02-analysis/30-nsduh-figure-OA8-difference_in_mj_use_by_state_2005_2017.do"
	///////////////////////////////////////////////////////////////////////////////
		
	///////////////////////////////////////////////////////////////////////////////
	// Figure OA9: Change in marijuana use across time by age group
	
	// <1 min
	do "code/02-analysis/31-nsduh-figure-OA9-difference-by-age-in-use.do"
	///////////////////////////////////////////////////////////////////////////////
		
	///////////////////////////////////////////////////////////////////////////////
	// Table OA22: Summary statistics of other variables
	
	// <1 min
	do "code/02-analysis/32-nsduh-table-OA22-summary-statistics-other-variables.do"
	///////////////////////////////////////////////////////////////////////////////
		
	///////////////////////////////////////////////////////////////////////////////
	// Tables OA23 and OA24: Look at only rm effect (do not separate out dispensary)
	
	// <1 min
	do "code/02-analysis/33-nsduh-tables-OA23-OA24-no-dispensary.do"
	///////////////////////////////////////////////////////////////////////////////
